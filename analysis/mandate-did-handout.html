<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.554">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Lee Kennedy-Shaffer, PhD">

<title>Staggered Adoption DID Analysis: COVID-19 Vaccine Mandates</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="mandate-did-handout_files/libs/clipboard/clipboard.min.js"></script>
<script src="mandate-did-handout_files/libs/quarto-html/quarto.js"></script>
<script src="mandate-did-handout_files/libs/quarto-html/popper.min.js"></script>
<script src="mandate-did-handout_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="mandate-did-handout_files/libs/quarto-html/anchor.min.js"></script>
<link href="mandate-did-handout_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="mandate-did-handout_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="mandate-did-handout_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="mandate-did-handout_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="mandate-did-handout_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Staggered Adoption DID Analysis: COVID-19 Vaccine Mandates</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Lee Kennedy-Shaffer, PhD </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="setting-and-data" class="level2">
<h2 class="anchored" data-anchor-id="setting-and-data">Setting and Data</h2>
<p>The concept of this analysis is based on that in <a href="https://doi.org/10.1073/pnas.2313610121">Rains and Richards (2024)</a>. The authors seek to understand the effect of COVID-19 vaccine mandates for state employees, which were implemented in 20 U.S. states, beginning on different dates in August–October 2021 (<a href="https://ballotpedia.org/State_employee_vaccine_requirements_during_the_coronavirus_(COVID-19)_pandemic,_2021-2023">Ballotpedia</a>). The vaccination data used are from the <a href="https://data.cdc.gov/Vaccinations/COVID-19-Vaccination-Trends-in-the-United-States-N/rh2h-3yt2/about_data">CDC’s COVID Vaccination Trends</a> data set. Note that the data might vary somewhat from that in the Rains and Richards (2024) <a href="https://doi.org/10.1073/pnas.2313610121">replication files</a>.</p>
<p>The goal of the analysis is to test the hypothesis that the state mandates increased either the number of first vaccinations in the state or the proportion of the state’s adult population that was fully vaccinated. Although not used by Rains and Richards (2024), we use non-mandate states as controls.</p>
<p>The data are available in the <code>mandate.Rda</code> file. <code>Vax_weekly</code> contains the full data set, by state and summarized by MMWR week, for January 2021 through May 2023, for two variables: <code>SCP</code> has the proportion of the adult population that has a complete vaccination series and <code>D1P</code> has the proportion of the adult population with at least one dose. The weekly increments are in the <code>_diff</code> variables. Information on the mandate for each start are in the <code>Mandate_Start</code>, <code>ever_mandate</code>, and <code>mandate</code> variables, and lead/lag information by week is in <code>Wks_mandate</code> and <code>LeadLag</code>.</p>
<p>First, load the data into R.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="at">file=</span><span class="st">"../data/mandate.Rda"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="libraries" class="level2">
<h2 class="anchored" data-anchor-id="libraries">Libraries</h2>
<p>Again, we will use <code>tidyverse</code> and <code>knitr</code> for general coding and <code>lme4</code> for clustered TWFE models. <a href="https://doi.org/10.1016/j.jeconom.2023.03.008">Roth et al.&nbsp;(2023)</a> has a summary table with <code>R</code> packages that implement advanced DID methods. We will use three of them:</p>
<ol type="1">
<li><p><code>bacondecomp</code> implements the decomposition from <a href="https://doi.org/10.1016/j.jeconom.2021.03.014">Goodman-Bacon (2021)</a>;</p></li>
<li><p><code>did2s</code>, described in <a href="https://journal.r-project.org/articles/RJ-2022-048/RJ-2022-048.pdf">Butts and Gardner (2022)</a>, implements the two-stage DID approach of <a href="https://doi.org/10.48550/arXiv.2207.05943">Gardner (2021)</a>, as well as many other proposed methods including the dynamic specification of <a href="https://doi.org/10.1093/restud/rdae007">Borusyak et al.&nbsp;(2024)</a>, the IW estimator of <a href="https://doi.org/10.1016/j.jeconom.2020.09.006">Sun and Abraham (2021)</a>, and the aggregated approach of <a href="https://doi.org/10.1016/j.jeconom.2020.12.001">Callaway and Sant’Anna (2021)</a>; and</p></li>
<li><p><code>DIDmultiplegt</code> implements the first-difference approach of <a href="https://doi.org/10.1257/aer.20181169">de Chaisemartin and d’Haultfoeuille (2020)</a>. Versions of this approach that can handle a wider array of settings, laid out in <a href="https://doi.org/10.1093/ectj/utac017">de Chaisemartin and d’Haultfoeuille (2023)</a> and <a href="https://doi.org/10.1162/rest_a_01414">de Chaisemartin and d’Haultfoeiulle (2024)</a>, along with sped-up analytic standard errors are implement in the <code>DIDmultiplegtDYN</code>, which requires Java for installation.</p></li>
</ol>
<p>We now load the required libraries.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="do">## If you have not installed these packages before,</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="do">##  run the following line:</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages(c("bacondecomp","did2s","DIDmultiplegt"))</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Either way, require the libraries:</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(tidyverse)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(knitr)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(lme4)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(bacondecomp)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(did2s)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(DIDmultiplegt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="graphical-exploration" class="level2">
<h2 class="anchored" data-anchor-id="graphical-exploration">Graphical Exploration</h2>
<p>We begin by plotting the time series for visual inspection. First, we plot a timeline of the mandate times.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Plot time series of mandates themselves:</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Plot of state employee vaccination mandate timings, U.S. states, June 2021–February 2022"</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "A bar plot with bars for each state over the time range specified, with twenty states switching from red to blue sometime between August 2021 and October 2021, and the rest remaining red throughout."</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>Vax_weekly, <span class="at">mapping=</span><span class="fu">aes</span>(<span class="at">x=</span>End_Date,<span class="at">y=</span>State, <span class="at">fill=</span>mandate)) <span class="sc">+</span> <span class="fu">geom_tile</span>() <span class="sc">+</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">name=</span><span class="st">"Date"</span>, <span class="at">date_breaks=</span><span class="st">"4 weeks"</span>, <span class="at">expand=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>),</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">limits=</span><span class="fu">c</span>(<span class="fu">as.Date</span>(<span class="st">"2021-06-05"</span>),<span class="fu">as.Date</span>(<span class="st">"2022-03-05"</span>)),</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">date_labels=</span><span class="st">"%m/%d/%y"</span>) <span class="sc">+</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> <span class="fu">guides</span>(<span class="at">fill=</span><span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 4250 rows containing missing values or values outside the scale range
(`geom_tile()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="mandate-did-handout_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can then plot the time series of the outcomes by state, noting which states implement a mandate and when.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Get lists of the states in the data and the states with a mandate at some point</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>states <span class="ot">&lt;-</span> <span class="fu">unique</span>(Vax_weekly <span class="sc">%&gt;%</span> <span class="fu">pull</span>(State))</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>mandate_states <span class="ot">&lt;-</span> <span class="fu">unique</span>(Vax_weekly <span class="sc">%&gt;%</span> </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>                           dplyr<span class="sc">::</span><span class="fu">filter</span>(mandate) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(State))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Plot time series of first-dose proportion by state:</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Plot of the proportion of U.S. adults with at least one COVID-19 vaccine dose, by state and state vaccine mandate status, June 2021–February 2022"</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "A line plot with lines for each state for dates from June 2021 to February 2022, and first-dose percentages generally increasing from a range around 45–80 at the beginning to a range around 70–90 at the end."</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data=</span>Vax_weekly <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span>(State <span class="sc">%in%</span> mandate_states)),</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">mapping=</span><span class="fu">aes</span>(<span class="at">x=</span>End_Date, <span class="at">y=</span>D1P, <span class="at">group=</span>State),</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">color=</span><span class="st">"grey50"</span>, <span class="at">linetype=</span><span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data=</span>Vax_weekly <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(State <span class="sc">%in%</span> mandate_states),</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">mapping=</span><span class="fu">aes</span>(<span class="at">x=</span>End_Date, <span class="at">y=</span>D1P, <span class="at">group=</span>State,</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>                        <span class="at">color=</span>mandate),</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">linetype=</span><span class="st">"solid"</span>) <span class="sc">+</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">name=</span><span class="st">"Mandate"</span>,</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>                       <span class="at">breaks=</span><span class="fu">c</span>(<span class="cn">TRUE</span>,<span class="cn">FALSE</span>),</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>                     <span class="at">values=</span><span class="fu">c</span>(<span class="st">"blue"</span>,<span class="st">"grey50"</span>),</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>                       <span class="at">labels=</span><span class="fu">c</span>(<span class="st">"Post-Mandate"</span>,<span class="st">"Pre-/No Mandate"</span>)) <span class="sc">+</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">name=</span><span class="st">"First-Dose Percentage"</span>,<span class="at">limits=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">100</span>), <span class="at">expand=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">name=</span><span class="st">"Date"</span>, <span class="at">date_breaks=</span><span class="st">"6 weeks"</span>, <span class="at">expand=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>),</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>               <span class="at">limits=</span><span class="fu">c</span>(<span class="fu">as.Date</span>(<span class="st">"2021-06-05"</span>),<span class="fu">as.Date</span>(<span class="st">"2022-03-05"</span>)),</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>               <span class="at">date_labels=</span><span class="st">"%m/%d/%y"</span>) <span class="sc">+</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 2490 rows containing missing values or values outside the scale range
(`geom_line()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1660 rows containing missing values or values outside the scale range
(`geom_line()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="mandate-did-handout_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Several states appear to have implausible declines or rates at 100. We can identify data errors that explain some of these peculiarities, e.g.&nbsp;<a href="https://www.nhpr.org/nh-news/2021-11-02/nh-covid-19-data-inaccurate">New Hampshire</a>, <a href="https://wjactv.com/news/local/data-correction-drops-covid-vaccine-rates-in-pennsylvania">Pennsylvania</a>, and <a href="https://www.spokesman.com/stories/2021/sep/21/explaining-the-discrepancy-between-cdc-and-health-/">Washington</a>. We will exclude these two states from the analysis, but a full analysis should examine the other states as well. We will also limit the analysis weeks to 2021, MMWR weeks 25–42 to both be more focused on timing around the implementation of mandates and exclude some data errors found at other times.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Exclude New Hampshire, Pennsylvania, Washington:</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>Vax_adj <span class="ot">&lt;-</span> Vax_weekly <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span>(State <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"NH"</span>,<span class="st">"PA"</span>,<span class="st">"WA"</span>)))</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Select weeks for analysis:</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>Yr_Wk_Sel <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"2021_"</span>,(<span class="dv">25</span><span class="sc">:</span><span class="dv">42</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We re-plot on this adjusted group of states and weeks.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Plot time series of first-dose proportion by state in smaller time window:</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Plot of the proportion of U.S. adults with at least one COVID-19 vaccine dose, by state and state vaccine mandate status, July 2021–October 2021"</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "A line plot with lines for each state for dates from July 2021 to October 2021, and first-dose percentages generally increasing from a range around 45–85 at the beginning to a range around 60–90 at the end."</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data=</span>Vax_adj <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span>(State <span class="sc">%in%</span> mandate_states), Yr_Wk <span class="sc">%in%</span> Yr_Wk_Sel),</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">mapping=</span><span class="fu">aes</span>(<span class="at">x=</span>End_Date, <span class="at">y=</span>D1P, <span class="at">group=</span>State),</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">color=</span><span class="st">"grey50"</span>, <span class="at">linetype=</span><span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data=</span>Vax_adj <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(State <span class="sc">%in%</span> mandate_states, Yr_Wk <span class="sc">%in%</span> Yr_Wk_Sel),</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">mapping=</span><span class="fu">aes</span>(<span class="at">x=</span>End_Date, <span class="at">y=</span>D1P, <span class="at">group=</span>State,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>                        <span class="at">color=</span>mandate),</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">linetype=</span><span class="st">"solid"</span>) <span class="sc">+</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">name=</span><span class="st">"Mandate"</span>,</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks=</span><span class="fu">c</span>(<span class="cn">TRUE</span>,<span class="cn">FALSE</span>),</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>                     <span class="at">values=</span><span class="fu">c</span>(<span class="st">"blue"</span>,<span class="st">"grey50"</span>),</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels=</span><span class="fu">c</span>(<span class="st">"Post-Mandate"</span>,<span class="st">"Pre-/No Mandate"</span>)) <span class="sc">+</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">name=</span><span class="st">"Full Vaccination Percentage"</span>,<span class="at">limits=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">100</span>), <span class="at">expand=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">name=</span><span class="st">"Date"</span>, <span class="at">date_breaks=</span><span class="st">"3 weeks"</span>, <span class="at">expand=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>),</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>               <span class="at">limits=</span><span class="fu">c</span>(<span class="fu">as.Date</span>(<span class="st">"2021-07-03"</span>),<span class="fu">as.Date</span>(<span class="st">"2021-10-24"</span>)),</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>               <span class="at">date_labels=</span><span class="st">"%m/%d/%y"</span>) <span class="sc">+</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 29 rows containing missing values or values outside the scale range
(`geom_line()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 18 rows containing missing values or values outside the scale range
(`geom_line()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="mandate-did-handout_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Similar plotting and analyses could be done on the complete series percentage by replacing <code>D1P</code> in the above code by <code>SCP</code>.</p>
</section>
<section id="discussion-questions" class="level2">
<h2 class="anchored" data-anchor-id="discussion-questions">Discussion Questions</h2>
<ol type="1">
<li><p>Is one outcome better suited to answering the question of interest than the other?</p></li>
<li><p>What forms of effect heterogeneity may be present in this staggered adoption setting?</p></li>
</ol>
</section>
<section id="twfe-models" class="level2">
<h2 class="anchored" data-anchor-id="twfe-models">TWFE Models</h2>
<p>First, we fit TWFE models (using <code>lmer</code> to get clustered confidence intervals), the so-called “static” specification. We fit it once with just the fixed effects, and once adding <code>D1P_prior</code> as a covariate.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Fit TWFE model with no covariates:</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>TWFE_D1P <span class="ot">&lt;-</span> <span class="fu">lmer</span>(D1P<span class="sc">~</span><span class="fu">factor</span>(MMWR_week)<span class="sc">+</span>State<span class="sc">+</span>mandate<span class="sc">+</span>(<span class="dv">1</span><span class="sc">|</span>State),</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data=</span>Vax_weekly <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(Yr_Wk <span class="sc">%in%</span> Yr_Wk_Sel))</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Get 95% CI:</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>TWFE_D1P_CI <span class="ot">&lt;-</span> <span class="fu">confint</span>(TWFE_D1P, <span class="at">parm=</span><span class="st">"mandateTRUE"</span>, <span class="at">level=</span><span class="fl">0.95</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Computing profile confidence intervals ...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Fit TWFE model with prior-week as covariate:</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>TWFE_D1P_ctrl <span class="ot">&lt;-</span> <span class="fu">lmer</span>(D1P<span class="sc">~</span>D1P_prior<span class="sc">+</span><span class="fu">factor</span>(MMWR_week)<span class="sc">+</span>State<span class="sc">+</span>mandate<span class="sc">+</span>(<span class="dv">1</span><span class="sc">|</span>State),</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data=</span>Vax_weekly <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(Yr_Wk <span class="sc">%in%</span> Yr_Wk_Sel))</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>TWFE_D1P_ctrl_CI <span class="ot">&lt;-</span> <span class="fu">confint</span>(TWFE_D1P_ctrl, <span class="at">parm=</span><span class="st">"mandateTRUE"</span>, <span class="at">level=</span><span class="fl">0.95</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Computing profile confidence intervals ...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Summarize results from the two models:</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>TWFE_results <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">Model=</span><span class="fu">c</span>(<span class="st">"Fixed Effects Only"</span>,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"Fixed Effects + Prior Week Value"</span>),</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">Estimate=</span><span class="fu">format</span>(<span class="fu">c</span>(<span class="fu">summary</span>(TWFE_D1P)<span class="sc">$</span>coefficients[<span class="st">"mandateTRUE"</span>,<span class="st">"Estimate"</span>],</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">summary</span>(TWFE_D1P_ctrl)<span class="sc">$</span>coefficients[<span class="st">"mandateTRUE"</span>,<span class="st">"Estimate"</span>]), <span class="at">digits=</span><span class="dv">3</span>, <span class="at">nsmall=</span><span class="dv">3</span>),</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">95% CI</span><span class="st">`</span><span class="ot">=</span><span class="fu">c</span>(<span class="fu">paste</span>(<span class="fu">format</span>(TWFE_D1P_CI[<span class="st">"mandateTRUE"</span>,], <span class="at">digits=</span><span class="dv">3</span>, <span class="at">nsmall=</span><span class="dv">3</span>), <span class="at">collapse=</span><span class="st">", "</span>),</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">paste</span>(<span class="fu">format</span>(TWFE_D1P_ctrl_CI[<span class="st">"mandateTRUE"</span>,], <span class="at">digits=</span><span class="dv">3</span>, <span class="at">nsmall=</span><span class="dv">3</span>), <span class="at">collapse=</span><span class="st">", "</span>)))</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="do">## Print the formatted table:</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(TWFE_results,</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>             <span class="at">caption=</span><span class="st">"Table of results from TWFE models"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<caption>Table of results from TWFE models</caption>
<thead>
<tr class="header">
<th style="text-align: left;">Model</th>
<th style="text-align: left;">Estimate</th>
<th style="text-align: left;">95% CI</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Fixed Effects Only</td>
<td style="text-align: left;">-0.3803</td>
<td style="text-align: left;">-0.6869, -0.0738</td>
</tr>
<tr class="even">
<td style="text-align: left;">Fixed Effects + Prior Week Value</td>
<td style="text-align: left;">0.0208</td>
<td style="text-align: left;">-0.0659, 0.1074</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The two models give diverging results, with fairly large confidence intervals, leading to no clear conclusion. The estimates are hard to interpret as well giving the changing circumstances of the states involved.</p>
</section>
<section id="goodman-bacon-decomposition" class="level2">
<h2 class="anchored" data-anchor-id="goodman-bacon-decomposition">Goodman-Bacon Decomposition</h2>
<p>We can conduct the Goodman-Bacon decomposition of the TWFE model to identify the weights given to different comparisons.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Conduct the decomposition and print summary:</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>bacon <span class="ot">&lt;-</span> <span class="fu">bacon</span>(D1P<span class="sc">~</span>mandate,</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">data=</span>Vax_adj <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(Yr_Wk <span class="sc">%in%</span> Yr_Wk_Sel),</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">id_var=</span><span class="st">"State"</span>,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">time_var=</span><span class="st">"MMWR_week"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                      type  weight  avg_est
1 Earlier vs Later Treated 0.14186  0.03461
2 Later vs Earlier Treated 0.05819  0.01646
3     Treated vs Untreated 0.79995 -0.61141</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Full decomposition:</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>bacon</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   treated untreated      estimate       weight                     type
2       31     99999 -0.1401340996 0.1591059182     Treated vs Untreated
3       38     99999 -1.4331034483 0.0478790958     Treated vs Untreated
4       39     99999  0.3643349754 0.2062484125     Treated vs Untreated
5       33     99999 -0.7011206897 0.1178562357     Treated vs Untreated
6       42     99999 -0.7325219743 0.0375666751     Treated vs Untreated
7       35     99999  0.7076293103 0.1178562357     Treated vs Untreated
8       36     99999 -2.5052843708 0.0567183134     Treated vs Untreated
9       32     99999 -5.3682937752 0.0567183134     Treated vs Untreated
12      38        31 -1.1695238095 0.0026670053 Later vs Earlier Treated
13      39        31 -0.0008333333 0.0121920244 Later vs Earlier Treated
14      33        31 -0.5483333333 0.0030480061 Later vs Earlier Treated
15      42        31 -1.1666666667 0.0025146050 Later vs Earlier Treated
16      35        31  0.5020833333 0.0048768098 Later vs Earlier Treated
17      36        31 -1.8704761905 0.0026670053 Later vs Earlier Treated
18      32        31 -4.1212121212 0.0008382017 Later vs Earlier Treated
20      31        38  1.1515873016 0.0032004064 Earlier vs Later Treated
22      39        38  0.4300000000 0.0005080010 Later vs Earlier Treated
23      33        38  0.8525000000 0.0020320041 Earlier vs Later Treated
24      42        38  0.0833333333 0.0003048006 Later vs Earlier Treated
25      35        38  1.5966666667 0.0015240030 Earlier vs Later Treated
26      36        38 -0.6181818182 0.0005588011 Earlier vs Later Treated
27      32        38 -3.1023809524 0.0010668021 Earlier vs Later Treated
29      31        39 -0.0263888889 0.0182880366 Earlier vs Later Treated
30      38        39 -1.3738461538 0.0016510033 Earlier vs Later Treated
32      33        39 -0.4183333333 0.0121920244 Earlier vs Later Treated
33      42        39  0.0155555556 0.0011430023 Later vs Earlier Treated
34      35        39  0.3530000000 0.0101600203 Earlier vs Later Treated
35      36        39 -2.0200000000 0.0041910084 Earlier vs Later Treated
36      32        39 -4.5371428571 0.0062230124 Earlier vs Later Treated
38      31        33  0.1111111111 0.0018288037 Earlier vs Later Treated
39      38        33 -0.4300000000 0.0012700025 Later vs Earlier Treated
40      39        33  0.5416666667 0.0060960122 Later vs Earlier Treated
42      42        33 -0.1981481481 0.0013716027 Later vs Earlier Treated
43      35        33  0.9250000000 0.0016256033 Later vs Earlier Treated
44      36        33 -1.2214285714 0.0010668021 Later vs Earlier Treated
45      32        33 -1.7571428571 0.0003556007 Earlier vs Later Treated
47      31        42  1.3111111111 0.0150876302 Earlier vs Later Treated
48      38        42 -0.3012820513 0.0039624079 Earlier vs Later Treated
49      39        42  1.3822222222 0.0160020320 Earlier vs Later Treated
50      33        42  0.7560185185 0.0109728219 Earlier vs Later Treated
52      35        42  1.9080952381 0.0106680213 Earlier vs Later Treated
53      36        42 -1.1560606061 0.0050292101 Earlier vs Later Treated
54      32        42 -3.7414285714 0.0053340107 Earlier vs Later Treated
56      31        35 -0.2763888889 0.0036576073 Earlier vs Later Treated
57      38        35 -1.2433333333 0.0007620015 Later vs Earlier Treated
58      39        35 -0.5975000000 0.0040640081 Later vs Earlier Treated
59      33        35 -0.4875000000 0.0016256033 Earlier vs Later Treated
60      42        35 -1.0785714286 0.0010668021 Later vs Earlier Treated
62      36        35 -1.6357142857 0.0003556007 Later vs Earlier Treated
63      32        35 -3.5761904762 0.0010668021 Earlier vs Later Treated
65      31        36  1.3311111111 0.0022860046 Earlier vs Later Treated
66      38        36  0.4200000000 0.0002540005 Later vs Earlier Treated
67      39        36  1.0650000000 0.0015240030 Later vs Earlier Treated
68      33        36  1.0250000000 0.0012192024 Earlier vs Later Treated
69      42        36  0.5833333333 0.0004572009 Later vs Earlier Treated
70      35        36  1.8400000000 0.0005080010 Earlier vs Later Treated
72      32        36 -2.3928571429 0.0007112014 Earlier vs Later Treated
74      31        32  1.3277777778 0.0004572009 Earlier vs Later Treated
75      38        32  1.0833333333 0.0007620015 Later vs Earlier Treated
76      39        32  2.0264285714 0.0035560071 Later vs Earlier Treated
77      33        32  3.1950000000 0.0005080010 Later vs Earlier Treated
78      42        32  1.1966666667 0.0007620015 Later vs Earlier Treated
79      35        32  3.1354166667 0.0012192024 Later vs Earlier Treated
80      36        32  0.6500000000 0.0007112014 Later vs Earlier Treated</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Plot decomposition results:</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Goodman-Bacon decomposition plot for TWFE model with no covariates"</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "Scatter plot of weight vs estimate with three types of points: Earlier vs Later Treated, with estimate values from -4.5 to 2 and weights from 0 to 0.025; Later vs Earlier Treated, with estimate values from -4 to 3 and weights from 0 to 0.02; and Treated vs Untreated, with estimate values from -5.5 to 1 and weights from 0.04 to 0.21."</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>bacon, <span class="at">mapping=</span><span class="fu">aes</span>(<span class="at">x=</span>estimate,<span class="at">y=</span>weight,<span class="at">shape=</span>type,<span class="at">color=</span>type)) <span class="sc">+</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="mandate-did-handout_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The decomposition indicates that the vast majority of the weight is on Treated vs Untreated comparisons (because of the large number of untreated units). One particular observation has a large negative estimate driving the overall estimate.</p>
</section>
<section id="dynamic-specification-and-iw-estimator" class="level2">
<h2 class="anchored" data-anchor-id="dynamic-specification-and-iw-estimator">Dynamic Specification and IW Estimator</h2>
<p>The <code>event_study</code> function in the <code>did2s</code> package implements many proposed DID/staggered adoption methods. These can be chosen using the <code>estimator</code> option, or all can be fit by setting <code>estimator="all"</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Run event_study function with estimator="all":</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>ES <span class="ot">&lt;-</span> <span class="fu">event_study</span>(<span class="at">data=</span>Vax_adj <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(Yr_Wk <span class="sc">%in%</span> Yr_Wk_Sel) <span class="sc">%&gt;%</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">left_join</span>(Vax_weekly <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(LeadLag<span class="sc">==</span><span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>                                dplyr<span class="sc">::</span><span class="fu">select</span>(State,MMWR_week) <span class="sc">%&gt;%</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">rename</span>(<span class="at">First_Week=</span>MMWR_week),</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>                              <span class="at">by=</span><span class="fu">join_by</span>(State)) <span class="sc">%&gt;%</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">left_join</span>(<span class="fu">tibble</span>(<span class="at">State=</span><span class="fu">unique</span>(Vax_weekly <span class="sc">%&gt;%</span> <span class="fu">pull</span>(State))) <span class="sc">%&gt;%</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">arrange</span>(State) <span class="sc">%&gt;%</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">mutate</span>(<span class="at">StateID=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(<span class="fu">unique</span>(Vax_weekly <span class="sc">%&gt;%</span> <span class="fu">pull</span>(State)))),</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>                              <span class="at">by=</span><span class="fu">join_by</span>(State)),</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>                  <span class="at">yname=</span><span class="st">"SCP"</span>,</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>                  <span class="at">idname=</span><span class="st">"StateID"</span>,</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>                  <span class="at">gname=</span><span class="st">"First_Week"</span>,</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>                  <span class="at">tname=</span><span class="st">"MMWR_week"</span>,</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>                  <span class="at">estimator=</span><span class="st">"all"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Note these estimators rely on different underlying assumptions. See Table 2 of `https://arxiv.org/abs/2109.05913` for an overview.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Estimating TWFE Model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Estimating using Gardner (2021)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Estimating using Callaway and Sant'Anna (2020)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pre_process_did(yname = yname, tname = tname, idname = idname, : Be aware that there are some small groups in your dataset.
  Check groups: 30,31,32,34,35,37,41.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in did::att_gt(yname = yname, tname = tname, idname = idname, gname =
gname, : Not returning pre-test Wald statistic due to singular covariance
matrix</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Estimating using Sun and Abraham (2020)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Estimating using Borusyak, Jaravel, Spiess (2021)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Estimating using Roth and Sant'Anna (2021)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in staggered::staggered(data_staggered, i = idname, t = tname, g =
gname, : The treatment cohorts g = 31, 35, 37 have a single cross-sectional
unit only. We drop these cohorts.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in compute_se_Thetahat_beta(beta = beta, Ybar_g_list, A_theta_list, :
var_conservative is less than adjustmentFactor
Warning in compute_se_Thetahat_beta(beta = beta, Ybar_g_list, A_theta_list, :
var_conservative is less than adjustmentFactor
Warning in compute_se_Thetahat_beta(beta = beta, Ybar_g_list, A_theta_list, :
var_conservative is less than adjustmentFactor
Warning in compute_se_Thetahat_beta(beta = beta, Ybar_g_list, A_theta_list, :
var_conservative is less than adjustmentFactor
Warning in compute_se_Thetahat_beta(beta = beta, Ybar_g_list, A_theta_list, :
var_conservative is less than adjustmentFactor
Warning in compute_se_Thetahat_beta(beta = beta, Ybar_g_list, A_theta_list, :
var_conservative is less than adjustmentFactor
Warning in compute_se_Thetahat_beta(beta = beta, Ybar_g_list, A_theta_list, :
var_conservative is less than adjustmentFactor</code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="do">## List all results:</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>ES</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                            estimator  term   estimate std.error
                               &lt;char&gt; &lt;num&gt;      &lt;num&gt;     &lt;num&gt;
  1:                             TWFE   -16  1.3746881 0.7170926
  2:                             TWFE   -15  0.9791773 0.8620365
  3:                             TWFE   -14  0.9784814 0.7868187
  4:                             TWFE   -13  0.4526908 0.5695002
  5:                             TWFE   -12  0.5844473 0.5250245
 ---                                                            
164: Borusyak, Jaravel, Spiess (2021)     8 -0.7063972 0.4807238
165: Borusyak, Jaravel, Spiess (2021)     9 -1.0444807 0.5019715
166: Borusyak, Jaravel, Spiess (2021)    10 -1.0671403 0.5265563
167: Borusyak, Jaravel, Spiess (2021)    11 -1.2019869 0.4521723
168: Borusyak, Jaravel, Spiess (2021)    12  0.6096405 0.4369625</code></pre>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Pick out a specific method:</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>ES <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(estimator<span class="sc">==</span><span class="st">"Borusyak, Jaravel, Spiess (2021)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                           estimator  term    estimate  std.error
                              &lt;char&gt; &lt;num&gt;       &lt;num&gt;      &lt;num&gt;
 1: Borusyak, Jaravel, Spiess (2021)   -16  1.34598013 0.70908568
 2: Borusyak, Jaravel, Spiess (2021)   -15  0.94532769 0.85061961
 3: Borusyak, Jaravel, Spiess (2021)   -14  0.94846115 0.77636228
 4: Borusyak, Jaravel, Spiess (2021)   -13  0.52003764 0.56208885
 5: Borusyak, Jaravel, Spiess (2021)   -12  0.63385061 0.51713071
 6: Borusyak, Jaravel, Spiess (2021)   -11  0.67239117 0.47076990
 7: Borusyak, Jaravel, Spiess (2021)   -10  0.61391508 0.40097055
 8: Borusyak, Jaravel, Spiess (2021)    -9  0.37487793 0.40346127
 9: Borusyak, Jaravel, Spiess (2021)    -8  0.59443575 0.32235189
10: Borusyak, Jaravel, Spiess (2021)    -7  0.59071367 0.28004896
11: Borusyak, Jaravel, Spiess (2021)    -6  0.45524881 0.22419105
12: Borusyak, Jaravel, Spiess (2021)    -5  0.35311548 0.18409354
13: Borusyak, Jaravel, Spiess (2021)    -4  0.25422824 0.14313427
14: Borusyak, Jaravel, Spiess (2021)    -3  0.15245679 0.09494747
15: Borusyak, Jaravel, Spiess (2021)    -2  0.05922846 0.04783152
16: Borusyak, Jaravel, Spiess (2021)     0 -0.33738616 0.20149141
17: Borusyak, Jaravel, Spiess (2021)     1 -0.35826346 0.23090451
18: Borusyak, Jaravel, Spiess (2021)     2 -0.37457823 0.26070118
19: Borusyak, Jaravel, Spiess (2021)     3 -0.47842488 0.30785285
20: Borusyak, Jaravel, Spiess (2021)     4 -0.53291082 0.34662250
21: Borusyak, Jaravel, Spiess (2021)     5 -0.80408403 0.34269134
22: Borusyak, Jaravel, Spiess (2021)     6 -0.87106514 0.40041263
23: Borusyak, Jaravel, Spiess (2021)     7 -0.89918359 0.41749779
24: Borusyak, Jaravel, Spiess (2021)     8 -0.70639721 0.48072376
25: Borusyak, Jaravel, Spiess (2021)     9 -1.04448070 0.50197151
26: Borusyak, Jaravel, Spiess (2021)    10 -1.06714031 0.52655626
27: Borusyak, Jaravel, Spiess (2021)    11 -1.20198694 0.45217230
28: Borusyak, Jaravel, Spiess (2021)    12  0.60964054 0.43696246
                           estimator  term    estimate  std.error</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Plot the results of the various estimators:</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Event-study results from various staggered adoption methods on the effect of state employee COVID-19 vaccine mandates, event times from -16 to 12."</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "Six event-study plots showing effect estimates and 95% confidence intervals at each lead/lag time from -16 to 12. The plots are labelled: TWFE, Borusyak, Jaravel, Spiess (2021), Callway and Sant'Anna (2020), Gardner (2021), Roth and Sant'Anna (2021), and Sun and Abraham (2020)."</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_event_study</span>(ES)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="mandate-did-handout_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>For easier inspection, particular estimators can be plotted alone, and the lead/lag times to show can be specified.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Plot the results for just the dynamic estimator:</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Event-study results using the dynamic specification described in Borusyak et al. (2021/2024) on the effect of state employee COVID-19 vaccine mandates, event times from -10 to 8."</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "A single event-study plot showing effect estimates and 95% confidence intervals at each lead/lag time from -10 to 8. The event times less than 0 tend to have positive estimates with CIs crossing or nearly crossing 0, and those greater than 0 tend to have negative estimates with CIs crossing or nearly crossing 0. The CIs are narrowest near event time 0, and the estimates are closest to 0 there."</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_event_study</span>(ES <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(estimator<span class="sc">==</span><span class="st">"Borusyak, Jaravel, Spiess (2021)"</span>),</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">horizon=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">10</span>,<span class="dv">8</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="mandate-did-handout_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Plot the results for just the IW estimator:</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Event-study results using the IW Estimator from Sun and Abraham (2020) on the effect of state employee COVID-19 vaccine mandates, event times from -10 to 8."</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "A single event-study plot showing effect estimates and 95% confidence intervals at each lead/lag time from -10 to 8. The event times less than 0 tend to have positive estimates with CIs crossing or nearly crossing 0, and those greater than 0 tend to have negative estimates with CIs crossing or nearly crossing 0. The CIs are narrowest near event time 0, and the estimates are closest to 0 there."</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_event_study</span>(ES <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(estimator<span class="sc">==</span><span class="st">"Sun and Abraham (2020)"</span>),</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">horizon=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">10</span>,<span class="dv">8</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="mandate-did-handout_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="first-difference-switching-effect" class="level2">
<h2 class="anchored" data-anchor-id="first-difference-switching-effect">First-Difference Switching Effect</h2>
<p>Using the <code>did_multiplegt</code> function from the <code>DIDmultiplegt</code> package, we can fit the de Chaisemartin and d’Haultfoeuille (2020) method to estimate the average treatment effect of the first period after adoption. Standard errors can be derived using the <code>brep</code> and <code>cluster</code> options, but we set it to 0 here to speed up the analysis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="do">## First, we prepare a data set with a variable with the First_Week of</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="do">##  mandate for each mandate state and a unique state ID number.</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>Vax_firstWeek <span class="ot">&lt;-</span> Vax_adj <span class="sc">%&gt;%</span> </span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(Yr_Wk <span class="sc">%in%</span> Yr_Wk_Sel) <span class="sc">%&gt;%</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(Vax_adj <span class="sc">%&gt;%</span> </span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">filter</span>(LeadLag<span class="sc">==</span><span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">select</span>(State,MMWR_week) <span class="sc">%&gt;%</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>              <span class="fu">rename</span>(<span class="at">First_Week=</span>MMWR_week),</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">by=</span><span class="fu">join_by</span>(State)) <span class="sc">%&gt;%</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(<span class="fu">tibble</span>(<span class="at">State=</span><span class="fu">unique</span>(Vax_adj <span class="sc">%&gt;%</span> <span class="fu">pull</span>(State))) <span class="sc">%&gt;%</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>              <span class="fu">arrange</span>(State) <span class="sc">%&gt;%</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>              <span class="fu">mutate</span>(<span class="at">StateID=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(<span class="fu">unique</span>(Vax_adj <span class="sc">%&gt;%</span> <span class="fu">pull</span>(State)))),</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">by=</span><span class="fu">join_by</span>(State))</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a><span class="do">## Run analysis method:</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>dCdH <span class="ot">&lt;-</span> <span class="fu">did_multiplegt</span>(<span class="at">df=</span>Vax_firstWeek,</span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>                       <span class="at">Y=</span><span class="st">"D1P"</span>,</span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>                       <span class="at">G=</span><span class="st">"StateID"</span>,</span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>                       <span class="at">T=</span><span class="st">"MMWR_week"</span>,</span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>                       <span class="at">D=</span><span class="st">"mandate"</span>,</span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>                       <span class="at">placebo=</span><span class="dv">10</span>,</span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>                       <span class="at">dynamic=</span><span class="dv">7</span>,</span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>                       <span class="at">brep=</span><span class="dv">0</span>,</span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>                       <span class="at">cluster=</span><span class="st">"StateID"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: There was 1 warning in `summarize()`.
ℹ In argument: `Tgroup = group_indices()`.
ℹ In group 1: `T = 25`.
Caused by warning:
! `group_indices()` was deprecated in dplyr 1.0.0.
ℹ Please use `cur_group_id()` instead.
ℹ The deprecated feature was likely used in the DIDmultiplegt package.
  Please report the issue to the authors.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="do">## See full results:</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>dCdH</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$effect
   treatment 
-0.009937251 

$N_effect
[1] 321

$N_switchers_effect
[1] 18

$dynamic_1
[1] -0.1409227

$N_dynamic_1
[1] 280

$N_switchers_effect_1
[1] 15

$dynamic_2
[1] -0.1573204

$N_dynamic_2
[1] 275

$N_switchers_effect_2
[1] 15

$dynamic_3
[1] -0.1712528

$N_dynamic_3
[1] 263

$N_switchers_effect_3
[1] 15

$dynamic_4
[1] -0.4340216

$N_dynamic_4
[1] 218

$N_switchers_effect_4
[1] 10

$dynamic_5
[1] -0.4988121

$N_dynamic_5
[1] 186

$N_switchers_effect_5
[1] 9

$dynamic_6
[1] -0.4722865

$N_dynamic_6
[1] 177

$N_switchers_effect_6
[1] 9

$dynamic_7
[1] -0.2888539

$N_dynamic_7
[1] 138

$N_switchers_effect_7
[1] 8

$placebo_1
[1] -0.01750961

$N_placebo_1
[1] 321

$placebo_2
[1] -0.06238722

$N_placebo_2
[1] 321

$placebo_3
[1] -0.0511033

$N_placebo_3
[1] 321

$placebo_4
[1] -0.04764996

$N_placebo_4
[1] 321

$placebo_5
[1] -0.01803485

$N_placebo_5
[1] 321

$placebo_6
[1] -0.08787976

$N_placebo_6
[1] 274

$placebo_7
[1] -0.05460744

$N_placebo_7
[1] 230

$placebo_8
[1] -0.08344529

$N_placebo_8
[1] 187

$placebo_9
[1] 0.2252317

$N_placebo_9
[1] 187

$placebo_10
[1] -0.1133561

$N_placebo_10
[1] 146</code></pre>
</div>
</div>
<p>The treatment effect estimate is -0.00994. We can also pull the dynamic and placebo effect estimates from the output.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Creating data set of placebo (in-time) effects. Note the time is negated to match usual event time notation.</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>placebo <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(dCdH) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"placebo"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols=</span><span class="fu">everything</span>(),</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to=</span><span class="st">"Lead"</span>,</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_prefix=</span><span class="st">"placebo_"</span>,</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to=</span><span class="st">"Estimate"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="st">`</span><span class="at">Event Time</span><span class="st">`</span><span class="ot">=</span><span class="sc">-</span><span class="dv">1</span><span class="sc">*</span><span class="fu">as.numeric</span>(Lead))</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="do">## Creating data set of single first-switch estimate.</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>estimate <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="st">`</span><span class="at">Event Time</span><span class="st">`</span><span class="ot">=</span><span class="dv">1</span>,</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>                   <span class="at">Estimate=</span>dCdH<span class="sc">$</span>effect[<span class="st">"treatment"</span>])</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a><span class="do">## Creating data set of dynamic effects. Note the time is incremented by 1 to match usual event time notation where 1 is the first period on treatment.</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>dynamic <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(dCdH) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"dynamic"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols=</span><span class="fu">everything</span>(),</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to=</span><span class="st">"Lag"</span>,</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_prefix=</span><span class="st">"dynamic_"</span>,</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to=</span><span class="st">"Estimate"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="st">`</span><span class="at">Event Time</span><span class="st">`</span><span class="ot">=</span><span class="fu">as.numeric</span>(Lag)<span class="sc">+</span><span class="dv">1</span>)</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a><span class="do">## Combined event time data set from this method:</span></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>dCdH_comb <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(placebo <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>Lead),</span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>                       estimate,</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>                       dynamic <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>Lag))</span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>dCdH_comb <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(<span class="st">`</span><span class="at">Event Time</span><span class="st">`</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 18 × 2
   Estimate `Event Time`
      &lt;dbl&gt;        &lt;dbl&gt;
 1 -0.113            -10
 2  0.225             -9
 3 -0.0834            -8
 4 -0.0546            -7
 5 -0.0879            -6
 6 -0.0180            -5
 7 -0.0476            -4
 8 -0.0511            -3
 9 -0.0624            -2
10 -0.0175            -1
11 -0.00994            1
12 -0.141              2
13 -0.157              3
14 -0.171              4
15 -0.434              5
16 -0.499              6
17 -0.472              7
18 -0.289              8</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Plot the results of first-switching analysis:</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Event-study results using the First-Switching Estimator from de Chaisemartin and d'Haultfoeuille (2020) on the effect of state employee COVID-19 vaccine mandates, event times from -10 to 8."</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "A single event-study plot showing effect estimates at each lead/lag time from -10 to 8. The event times less than 0 tend to have small negative estimates (between 0 and -0.125), except for time -9 which has an estimate of nearly 0.25. The event time of 1 has an estimate slightly below 0 as well. The estimates from event times 2 through 4 are around -0.15, from event times 5 to 7 are around -0.40, and from event time 8 is around -0.3."</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dCdH_comb) <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="at">mapping=</span><span class="fu">aes</span>(<span class="at">x=</span><span class="st">`</span><span class="at">Event Time</span><span class="st">`</span>, <span class="at">y=</span>Estimate)) <span class="sc">+</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="mandate-did-handout_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>If you install the <code>DIDmultiplegtDYN</code> package, a faster implementation of standard errors and more standard interface is available through the <code>did_multiplegtDYN</code> function. Note that this package requires Java and at least R 4.3.3, and may cause errors in other settings.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Run the above analysis with the DIDmultiplegtDYN package instead:</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("DIDmultiplegtDYN")</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(DIDmultiplegtDYN)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: DIDmultiplegtDYN</code></pre>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>dCdH_dyn <span class="ot">&lt;-</span> <span class="fu">did_multiplegt_dyn</span>(<span class="at">df=</span>Vax_firstWeek,</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>                               <span class="at">outcome=</span><span class="st">"D1P"</span>,</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>                               <span class="at">group=</span><span class="st">"StateID"</span>,</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>                               <span class="at">time=</span><span class="st">"MMWR_week"</span>,</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>                               <span class="at">treatment=</span><span class="st">"mandate"</span>,</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>                               <span class="at">effects=</span><span class="dv">8</span>,</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>                               <span class="at">placebo=</span><span class="dv">8</span>,</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>                               <span class="at">cluster=</span><span class="st">"StateID"</span>,</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>                               <span class="at">graph_off=</span><span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="mandate-did-handout_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>dCdH_dyn</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
----------------------------------------------------------------------
       Estimation of treatment effects: Event-study effects
----------------------------------------------------------------------
             Estimate SE      LB CI    UB CI   N   Switchers
Effect_1     -0.00994 0.04814 -0.10429 0.08441 321 18       
Effect_2     -0.14092 0.09131 -0.31988 0.03804 280 15       
Effect_3     -0.15732 0.13387 -0.41971 0.10507 275 15       
Effect_4     -0.17125 0.17020 -0.50485 0.16234 263 15       
Effect_5     -0.43402 0.29681 -1.01576 0.14772 218 10       
Effect_6     -0.49881 0.40189 -1.28650 0.28887 186 9        
Effect_7     -0.47229 0.44699 -1.34838 0.40381 177 9        
Effect_8     -0.28885 0.56507 -1.39638 0.81867 138 8        

----------------------------------------------------------------------
    Average cumulative (total) effect per treatment unit
----------------------------------------------------------------------
 Estimate        SE     LB CI     UB CI         N Switchers 
 -0.22841   0.21237  -0.64464   0.18783       545        99 
Average number of time periods over which a treatment effect is accumulated: 3.8788

----------------------------------------------------------------------
     Testing the parallel trends and no anticipation assumptions
----------------------------------------------------------------------
             Estimate SE      LB CI    UB CI   N   Switchers
Placebo_1    0.01751  0.05495 -0.09019 0.12521 321 18       
Placebo_2    0.13483  0.12339 -0.10701 0.37668 280 15       
Placebo_3    0.19539  0.18846 -0.17399 0.56477 275 15       
Placebo_4    0.25257  0.25594 -0.24907 0.75421 263 15       
Placebo_5    0.44685  0.39496 -0.32725 1.22096 218 10       
Placebo_6    0.84753  0.67821 -0.48173 2.17679 145 6        
Placebo_7    0.62478  0.89497 -1.12932 2.37889 98  5        
Placebo_8    0.48793  0.70533 -0.89448 1.87035 31  2        

Test of joint nullity of the placebos : p-value = 0.0000


The development of this package was funded by the European Union.
ERC REALLYCREDIBLE - GA N. 101043899</code></pre>
</div>
</div>
</section>
<section id="additional-options" class="level2">
<h2 class="anchored" data-anchor-id="additional-options">Additional Options</h2>
<p>Other methods and specifications are possible, along with incorporating covariates into some of these methods. The review papers listed in the slides are a good place to start to investigate these.</p>
</section>
<section id="discussion-question" class="level2">
<h2 class="anchored" data-anchor-id="discussion-question">Discussion Question</h2>
<p>Is this question and its associated data set a good fit for a DID/staggered adoption analysis? Why or why not?</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>